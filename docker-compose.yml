# CivicTrack - Local container validation (Supabase-backed)
# Usage: docker compose up --build
# Pass env via .env file (copy from .env.example, never commit secrets)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: civictrack-backend
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - HOSTNAME=0.0.0.0
      - SKIP_HTTPS_REDIRECT=1
      # Inject at runtime - use env_file or -e. Never hardcode.
      - DATABASE_URL
      - JWT_SECRET
      - JWT_REFRESH_SECRET
      - CORS_ORIGIN
      - SUPABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_BUCKET
      - SECRET_PROVIDER
      - SUPABASE_DATABASE_URL
    env_file:
      - ./backend/.env
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:5000}
        NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-CivicTrack}
    container_name: civictrack-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - SKIP_HTTPS_REDIRECT=1
    env_file:
      - ./backend/.env
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

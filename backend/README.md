# Backend API Server (Next.js)

This is a Next.js API-only backend server running on port 5000.

## Setup

1. Install dependencies:
```bash
npm install
```

2. Generate Prisma client:
```bash
npx prisma generate
```

3. Run migrations (if needed):
```bash
npx prisma migrate deploy
```

4. Start development server:
```bash
npm run dev
```

The server will start on http://localhost:5000

## API Routes

- `GET /api/health` - Health check
- `GET /api/test-db` - Test database connection
- `POST /api/auth/signup` - User signup
- `POST /api/auth/login` - User login

## Authentication vs Authorization

- **Authentication** answers: _"Who are you?"_
  - Implemented by `POST /api/auth/signup` and `POST /api/auth/login`.
  - On login, the backend verifies the email/password with Prisma and issues a **JWT** that includes the user id, email, and `role` (either `"user"` or `"admin"`).
  - The JWT is signed with `JWT_SECRET` loaded from environment variables; no secrets are hardcoded in the codebase.
- **Authorization** answers: _"What are you allowed to do?"_
  - Implemented by role-based checks (`role` field on the `User` model and `role` claim in the JWT).
  - Middleware and API routes use the `role` to decide if access should be granted or denied.

## Authorization Middleware (RBAC) Flow

> Note: The global authorization middleware is implemented in the frontend Next.js app and protects the `/api/users` and `/api/admin` routes. It uses the same `JWT_SECRET` so it can verify the JWTs generated by this backend.

- **1. Incoming request**
  - Client calls one of:
    - `GET /api/users`
    - `GET /api/admin`
  - Request must include `Authorization: Bearer <JWT>` header.
- **2. Middleware checks**
  - If the `Authorization` header is **missing**:
    - Returns a JSON error with **HTTP 401** (unauthorized).
  - If the token is **invalid or expired**:
    - Returns a JSON error with **HTTP 403** (forbidden).
  - If the path starts with `/api/admin` and the user `role` in the token is **not** `"admin"`:
    - Returns a JSON error with **HTTP 403** (forbidden).
  - On success:
    - Middleware attaches decoded user information to the request headers:
      - `x-user-email`
      - `x-user-role`
    - Request is forwarded to the target API route.
- **3. API route behavior**
  - `/api/users`:
    - Requires a **valid JWT** (any role: `"user"` or `"admin"`).
  - `/api/admin`:
    - Requires a **valid JWT** with `role === "admin"`.

All error responses are JSON only (no redirects), and use the shared `responseHandler.ts` and `errorCodes.ts` utilities for a consistent response shape.

## Role-Based Access Control (RBAC)

- The Prisma `User` model (backend) has a `role` field:
  - Possible values: `"admin"`, `"user"` (enforced via a Prisma `Role` enum).
  - Default value: `"user"`.
- The `role` is:
  - Stored in the database.
  - Included in the JWT payload after login.
  - Read by the middleware to enforce access rules.

### Allowed vs Denied Examples

- **Allowed**
  - `GET /api/users` with a valid JWT for a `"user"`:
    - ✅ Allowed (HTTP 200).
  - `GET /api/users` with a valid JWT for an `"admin"`:
    - ✅ Allowed (HTTP 200).
  - `GET /api/admin` with a valid JWT for an `"admin"`:
    - ✅ Allowed (HTTP 200) and returns a success message.
- **Denied**
  - `GET /api/users` with **no token**:
    - ❌ Denied with **401** (missing token).
  - `GET /api/users` with an **invalid/expired** token:
    - ❌ Denied with **403**.
  - `GET /api/admin` with a valid JWT for a `"user"`:
    - ❌ Denied with **403** (not enough privileges).

## Least-Privilege Principle

This project follows the **least-privilege principle**:

- New users are created with the lowest privilege by default:
  - `role = "user"`.
- Admin-only routes (`/api/admin`) are strictly guarded:
  - Only tokens with `role === "admin"` are allowed through middleware.
- Shared middleware centralizes authorization logic:
  - Reduces duplication and the chance of accidentally exposing sensitive routes.
- The `role` is part of the JWT payload:
  - API routes can make additional fine-grained checks when necessary without performing extra database lookups.

By default, users can only access what they need (`/api/users` with valid JWT), while sensitive admin operations are limited to a small, trusted set of identities.

## Environment Variables

Create a `.env` file with:
```
DATABASE_URL=postgresql://postgres:password@localhost:5432/mydb
PORT=5000
JWT_SECRET=your-secret-key
```

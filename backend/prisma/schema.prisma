generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// CivicTrack: Citizen, Officer, Admin (PRD)
enum Role {
  citizen
  officer
  admin
}

enum IssueCategory {
  GARBAGE
  WATER_SUPPLY
  ROAD_DAMAGE
  STREETLIGHT
  OTHER
}

enum IssueStatus {
  REPORTED
  ASSIGNED
  IN_PROGRESS
  RESOLVED
}

model User {
  id             Int      @id @default(autoincrement())
  name           String
  email          String   @unique
  password       String?
  role           Role     @default(citizen)
  createdAt      DateTime @default(now())
  projects       Project[]
  reportedIssues Issue[]  @relation("ReportedBy")
  assignedIssues Issue[]  @relation("AssignedTo")
  progressUpdates ProgressUpdate[]
}

model Project {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([userId])
}

model Task {
  id        Int      @id @default(autoincrement())
  title     String
  status    String
  projectId Int
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
}

// CivicTrack Issue (PRD: issueId, title, description, category, geoLocation, status, assignedTo, SLA, media, timeline)
model Issue {
  id                 Int          @id @default(autoincrement())
  publicId           String?      @unique // e.g. CT-00001, set after create
  title              String
  description        String?
  category           IssueCategory
  latitude           Decimal?     @db.Decimal(10, 7)
  longitude          Decimal?     @db.Decimal(10, 7)
  status             IssueStatus  @default(REPORTED)
  reportedById       Int
  assignedToId       Int?
  slaDeadline        DateTime?    // Expected completion date
  progressPercentage Int          @default(0) // 0-100
  isAnonymous        Boolean      @default(false)
  upvotes            Int          @default(0)
  mediaUrls          Json?        // string[] URLs
  resolutionNotes    String?
  proofUrls          Json?        // before/after URLs
  satisfactionRating Int?
  reopened           Boolean      @default(false)
  timeline           Json?        // [{ at, status, by }]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  reportedBy User?  @relation("ReportedBy", fields: [reportedById], references: [id], onDelete: Cascade)
  assignedTo User?  @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  progressUpdates    ProgressUpdate[]

  @@index([status])
  @@index([category])
  @@index([reportedById])
  @@index([assignedToId])
  @@index([createdAt])
}

// Daily progress updates by assigned workers
model ProgressUpdate {
  id          Int      @id @default(autoincrement())
  issueId     Int
  percentage  Int      // Progress percentage (0-100)
  notes       String?  // What work was done
  updatedById Int      // Who updated the progress
  createdAt   DateTime @default(now())

  issue     Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  updatedBy User  @relation(fields: [updatedById], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([createdAt])
  @@index([updatedById])
}
